{% extends "base.html" %}
{% load static %}

{% block title %}Ecome - {{ product.name }}{% endblock %}

{% block content %}
<!-- ========== BOOTSTRAP CDN ========== -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-5">
  <div class="row g-4">
    <!-- ================= PRODUCT IMAGES ================= -->
    <div class="col-md-6">
      <div id="productImagesCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded shadow-sm">
          {% if product.image %}
          <div class="carousel-item active">
            <img src="{{ product.image.url }}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="{{ product.name }}">
          </div>
          {% endif %}
          {% if product.image1 %}
          <div class="carousel-item">
            <img src="{{ product.image1.url }}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="{{ product.name }} Image 1">
          </div>
          {% endif %}
          {% if product.image2 %}
          <div class="carousel-item">
            <img src="{{ product.image2.url }}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="{{ product.name }} Image 2">
          </div>
          {% endif %}
          {% if product.image3 %}
          <div class="carousel-item">
            <img src="{{ product.image3.url }}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="{{ product.name }} Image 3">
          </div>
          {% endif %}
          {% if product.image4 %}
          <div class="carousel-item">
            <img src="{{ product.image4.url }}" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="{{ product.name }} Image 4">
          </div>
          {% endif %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>

        <div class="carousel-indicators mt-3 position-static d-flex flex-wrap justify-content-center">
          {% if product.image %}
          <img src="{{ product.image.url }}" data-bs-target="#productImagesCarousel" data-bs-slide-to="0"
               class="active rounded m-1" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          {% endif %}
          {% if product.image1 %}
          <img src="{{ product.image1.url }}" data-bs-target="#productImagesCarousel" data-bs-slide-to="1"
               class="rounded m-1" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          {% endif %}
          {% if product.image2 %}
          <img src="{{ product.image2.url }}" data-bs-target="#productImagesCarousel" data-bs-slide-to="2"
               class="rounded m-1" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          {% endif %}
          {% if product.image3 %}
          <img src="{{ product.image3.url }}" data-bs-target="#productImagesCarousel" data-bs-slide-to="3"
               class="rounded m-1" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          {% endif %}
          {% if product.image4 %}
          <img src="{{ product.image4.url }}" data-bs-target="#productImagesCarousel" data-bs-slide-to="4"
               class="rounded m-1" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ================= PRODUCT DETAILS ================= -->
    <div class="col-md-6 d-flex flex-column p-4 bg-light rounded shadow-lg">
      <h2 class="fw-bold mb-2">{{ product.name }}</h2>
      <p class="text-muted mb-1"><strong>Brand:</strong> {{ product.brand }}</p>
      <hr>

      <h3 class="text-success fw-bold mb-2">{{ product.price }} $</h3>
      {% if not product.is_bidding_open and product.winner %}
        <div class="alert alert-success mt-3">
          Winner: <strong>{{ product.winner.username }}</strong><br>
          Winning Bid:
          {% with product.bids.all|dictsortreversed:"amount"|first as top_bid %}
            {{ top_bid.amount }} $
          {% endwith %}
        </div>
      {% endif %}

      <p class="mb-2"><strong>Discount:</strong>
        <span class="badge bg-danger rounded-pill px-3 py-2">{{ product.discount }}%</span>
      </p>

      <p class="mb-2"><strong>Stock:</strong>
        {% if product.stock > 0 %}
        <span class="text-success fw-bold">In Stock ({{ product.stock }})</span>
        {% else %}
        <span class="text-danger fw-bold">Out of Stock</span>
        {% endif %}
      </p>

      <p class="mb-4">
        <strong>Description:</strong><br>
        {{ product.description|default:"No description available." }}
      </p>

<div class="mt-auto d-flex gap-3 flex-wrap">
  {% if user.is_authenticated %}
    {% if product in cart_products %}
      <button class="btn text-dark fw-bold flex-grow-1" 
              style="background: #00ff99;" disabled>
        Added to Cart
      </button>
    {% else %}
      <a href="{% url 'add_cart' product.slug %}" 
         class="btn text-dark fw-bold flex-grow-1" 
         style="background: #f3d6a1;">
         Add to Cart
      </a>
    {% endif %}
  {% else %}
    <a href="{% url 'login' %}?next={% url 'product_detail' product.slug %}" 
       class="btn text-dark fw-bold flex-grow-1" 
       style="background: #FFA500;">
       Login to Add Cart
    </a>
  {% endif %}

  <a href="#" class="btn fw-bold flex-grow-1" style="background: #e74545ff;">Buy Now</a>

  {% if user.is_authenticated %}
    {% if liked %}
      <a href="{% url 'unlike_product' product.slug %}" class="btn" style="background: #f96161;">Dislike</a>
    {% else %}
      <form action="{% url 'add_like' product.slug %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn" style="background: #aaff77;">Like</button>
      </form>
    {% endif %}
  {% endif %}
</div>

    </div>
  </div>
</div>

<!-- ================= REVIEWS & BIDDINGS ================= -->
<div class="container my-5">
  <div class="row g-4">

    <!-- ==================== BIDS SECTION ==================== -->
    <div class="col-md-12 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0">All Bids</h5>

        {% if user.is_authenticated and product.is_bidding_open %}
        <button
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#bidModal"
        >
          Place Your Bid
        </button>
        {% endif %}
      </div>

      {% if request.user == product.user and product.is_bidding_open %}
      <div class="text-end mb-3">
        <a href="{% url 'close_bid' product.slug %}" class="btn btn-danger">
          Close Bid
        </a>
      </div>
      {% endif %}

      {% if not product.is_bidding_open %}
      <div class="alert alert-danger text-center fw-semibold shadow-sm">
        Biddings are closed for this product.
      </div>
      {% endif %}

      {% for bid in bids %}
      <div class="card mb-2 shadow-sm border-0">
        <div
          class="card-body d-flex justify-content-between align-items-center"
        >
          <div>
            <span class="fw-semibold">{{ bid.user.username }}</span>
            <small class="text-muted d-block">on {{ bid.product.name }}</small>

            {% if bid.user == user %}
            <a
              href="{% url 'edit_bid' bid.id %}"
              class="btn btn-sm btn-outline-primary mt-1"
            >
              Edit Bid
            </a>
            {% endif %}
          </div>
          <span class="text-success fw-bold fs-5">${{ bid.amount }}</span>
        </div>
      </div>
      {% empty %}
      <p class="text-center text-muted">No bids yet. Be the first to bid!</p>
      {% endfor %}
    </div>

    <!-- ==================== REVIEWS SECTION ==================== -->
    <div class="col-md-12 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0">Customer Reviews</h5>

        {% if user.is_authenticated %}
        <button
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#reviewModal"
        >
          Add Review
        </button>
        {% else %}
        <a href="{% url 'login' %}" class="btn btn-primary">
          Login to Review
        </a>
        {% endif %}
      </div>

      {% for review in reviews %}
      <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h6 class="fw-semibold mb-1">{{ review.user.username }}</h6>
            <small class="text-warning">
              {% for i in "12345"|make_list %}
                {% if forloop.counter <= review.rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </small>
          </div>
          <p class="card-text text-muted mt-1">{{ review.comment }}</p>
        </div>
      </div>
      {% empty %}
      <p class="text-center text-muted">No reviews yet.</p>
      {% endfor %}
    </div>

  </div>
</div>


<!-- ==================== BID MODAL ==================== -->
<div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">  <!-- Center Modal -->
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-dark text-light">
        <h5 class="modal-title" id="bidModalLabel">Place Your Bid</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-dark"  style="background-color: #2c2f33;">
        <form method="POST" action="{% url 'add_bid' product.slug %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-semibold">Your Bid Amount</label>
            <input type="number" name="amount" class="form-control" placeholder="Enter amount" required>
          </div>
          <button type="submit" class="btn btn-outline-success w-100 ">Submit Bid</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ==================== REVIEW MODAL ==================== -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 " style="background-color: #2c2f33;">
      <div class="modal-header border-0">
        <h5 class="modal-title text-light fw-bold" id="reviewModalLabel">
          Write a Review for {{ product.name }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" class="needs-validation" novalidate action="{% url 'add_review' product.slug %}">
          {% csrf_token %}

          <!-- Star Rating -->
          <div class="mb-3">
            <label class="form-label fw-semibold text-light">Your Rating</label>
            <div class="star-rating">
              <input type="radio" name="rating" id="star5" value="5" required>
              <label for="star5" title="5 stars">★</label>
              <input type="radio" name="rating" id="star4" value="4">
              <label for="star4" title="4 stars">★</label>
              <input type="radio" name="rating" id="star3" value="3">
              <label for="star3" title="3 stars">★</label>
              <input type="radio" name="rating" id="star2" value="2">
              <label for="star2" title="2 stars">★</label>
              <input type="radio" name="rating" id="star1" value="1">
              <label for="star1" title="1 star">★</label>
            </div>
            <div class="invalid-feedback rating-error">
              Please select a rating.
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-3">
            <label for="comment" class="form-label fw-semibold text-light">Your Review</label>
            <textarea name="comment" id="comment" rows="3" class="form-control bg-dark text-light border-0" placeholder="Share your thoughts..." style="resize: vertical; height: 298px;" required=""></textarea>
            <div class="invalid-feedback">
              Please enter your review.
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-outline-primary btn-sm">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ==================== SCRIPT ==================== -->
<script>
  (function () {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })

    // Hide rating error when star is selected
    const ratingInputs = document.querySelectorAll('.star-rating input')
    const ratingError = document.querySelector('.rating-error')
    ratingInputs.forEach(input => {
      input.addEventListener('change', () => {
        if (document.querySelector('.star-rating input:checked')) {
          ratingError.style.display = 'none'
        }
      })
    })
  })();
</script>

<!-- ==================== STYLES ==================== -->
<style>
  .star-rating {
    direction: rtl;
    display: inline-flex;
    font-size: 1.5rem;
    color: #666;
  }
  .star-rating input { display: none; }
  .star-rating label {
    cursor: pointer;
    margin: 0 2px;
  }
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: #f5c518;
  }
  .invalid-feedback.rating-error {
    display: block;
    color: #dc3545;
  }
  .modal-content {
    border-radius: 12px;
  }
</style>



{% endblock %}
